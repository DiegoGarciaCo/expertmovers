name: cd
on:
  push:
    branches: [main]
jobs:
  build-and-push:
    name: build-and-push
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: checkout code
        uses: actions/checkout@v4

      - name: set up node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: install deps
        run: npm ci

      - name: build app
        env:
          PORT: ${{ secrets.PORT }}
        run: npm run build

      - name: login to docker hub
        uses: docker/login-action@v3
        with:
          username: ${{vars.DOCKERHUB_USERNAME}}
          password: ${{secrets.DOCKERHUB_TOKEN}}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          push: true
          tags: dgarcia51/expertmovers:${{ github.sha }},dgarcia51/expertmovers:latest
          secrets: |
            PORT=${{ secrets.PORT }}

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs:
      - build-and-push
    steps:
      - name: checkout code
        uses: actions/checkout@v4

      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: soldbyghost.com
          username: ghost
          key: ${{ secrets.SSH_KEY }}
          script: |
            # Create working directory
            mkdir -p ~/expertmovers
            cd ~/expertmovers

            # Create docker-compose.yml
            cat > docker-compose.yml << 'COMPOSE_EOF'
            services:
              app:
                image: dgarcia51/expertmovers:latest
                ports:
                  - "4005:4005"
                environment:
                  - PORT=${PORT}
                  - NODE_ENV=production
                deploy:
                  replicas: 1
                  update_config:
                    parallelism: 1
                    delay: 10s
                    failure_action: rollback
            COMPOSE_EOF

            # Export environment variables
            export PORT=${{ secrets.PORT }}

            # Deploy stack
            docker stack deploy -c docker-compose.yml expertmovers

            # Show status
            echo "Deployment complete!"
            docker stack ps expertmovers
